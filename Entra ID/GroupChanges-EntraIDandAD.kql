// Group Membership Changes - Last 24 Hours
let aad_changes = 
    AuditLogs
    | where TimeGenerated > ago(24h)
    | where OperationName in ("Add member to group", "Remove member from group")
    | extend Actor = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)
    | extend Target = tostring(TargetResources[0].userPrincipalName)
    | extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))
    | extend GroupName = case(
        OperationName == "Add member to group", tostring(parse_json(tostring(ModifiedProps[1].newValue))),
        OperationName == "Remove member from group", tostring(parse_json(tostring(ModifiedProps[1].oldValue))),
        ""
    )
    | extend GroupID = case(
        OperationName == "Add member to group", tostring(parse_json(tostring(ModifiedProps[0].newValue))),
        OperationName == "Remove member from group", tostring(parse_json(tostring(ModifiedProps[0].oldValue))),
        ""
    )
    | extend Action = case(
        OperationName == "Add member to group", "Add",
        OperationName == "Remove member from group", "Remove",
        "Unknown"
    )
    | where isnotempty(Actor) and isnotempty(Target)
    | extend Environment = "â˜ï¸ Entra ID"
    | project TimeGenerated, Action, Actor, Target, GroupName, GroupID, Environment;
let ad_changes = 
    SecurityEvent
    | where TimeGenerated > ago(24h)
    | where AccountType == "User" 
    | where EventID in (4728, 4729, 4732, 4733, 4756, 4757)
    | parse MemberName with * 'CN=' Target ',OU=' *
    | extend Action = case(
        EventID in (4728, 4756, 4732), "Add",
        EventID in (4729, 4757, 4733), "Remove", 
        "Unknown"
    )
    | extend Environment = "ğŸ¢ On-Prem AD"
    | project 
        TimeGenerated,
        Action,
        Actor = SubjectUserName,
        Target,
        GroupName = TargetUserName,
        GroupID = TargetSid,
        Environment;
union aad_changes, ad_changes
| extend 
    TimeWindow = case(
        TimeGenerated > ago(1h), "ğŸ”´ Last Hour",
        TimeGenerated > ago(6h), "ğŸŸ¡ Last 6 Hours", 
        "ğŸŸ  Last 24 Hours"
    ),
    ActionDisplay = case(
        Action == "Add", "â• Add",
        Action == "Remove", "â– Remove",
        "â“ Unknown"
    ),
    DateFormatted = format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss")
| project 
    DateFormatted,
    TimeWindow,
    Environment,
    ActionDisplay,
    Actor,
    Target,
    GroupName,
    GroupID,
    TimeGenerated  // Keep for sorting
| order by TimeGenerated desc
| project-away TimeGenerated  // Remove from display
